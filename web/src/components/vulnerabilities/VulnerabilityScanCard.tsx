import { ScanResponse } from '@/api/client'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { TimeAgo } from '@/components/utils/TimeAgo'
import { AlertTriangle, CheckCircle, Info, Shield, XCircle } from 'lucide-react'
import { Link } from 'react-router-dom'

interface VulnerabilityScanCardProps {
  scan: ScanResponse
  projectSlug: string
  environmentName?: string
  showEnvironment?: boolean
}

function getSeverityColor(severity: 'critical' | 'high' | 'medium' | 'low'): string {
  switch (severity) {
    case 'critical':
      return 'bg-red-500/10 text-red-500 border-red-500/20'
    case 'high':
      return 'bg-orange-500/10 text-orange-500 border-orange-500/20'
    case 'medium':
      return 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
    case 'low':
      return 'bg-blue-500/10 text-blue-500 border-blue-500/20'
  }
}

function getSeverityIcon(severity: 'critical' | 'high' | 'medium' | 'low') {
  switch (severity) {
    case 'critical':
      return XCircle
    case 'high':
      return AlertTriangle
    case 'medium':
      return Info
    case 'low':
      return CheckCircle
  }
}

interface SeverityBadgeProps {
  severity: 'critical' | 'high' | 'medium' | 'low'
  count: number
}

function SeverityBadge({ severity, count }: SeverityBadgeProps) {
  const Icon = getSeverityIcon(severity)
  const label = severity.charAt(0).toUpperCase() + severity.slice(1)

  return (
    <div className={`flex items-center gap-2 rounded-md px-3 py-2 ${getSeverityColor(severity)}`}>
      <Icon className="h-4 w-4 flex-shrink-0" />
      <div className="flex flex-col">
        <span className="text-xs font-medium">{label}</span>
        <span className="text-lg font-bold">{count}</span>
      </div>
    </div>
  )
}

export function VulnerabilityScanCard({
  scan,
  projectSlug,
  environmentName,
  showEnvironment = false,
}: VulnerabilityScanCardProps) {
  const totalVulnerabilities =
    scan.critical_count + scan.high_count + scan.medium_count + scan.low_count

  const hasCritical = scan.critical_count > 0
  const hasHigh = scan.high_count > 0
  const hasVulnerabilities = totalVulnerabilities > 0

  return (
    <Link to={`/projects/${projectSlug}/security/scans/${scan.id}`}>
      <Card className="hover:bg-muted/50 transition-colors">
        <CardHeader className="pb-3">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-2">
              <Shield className="h-4 w-4 text-muted-foreground" />
              <CardTitle className="text-base font-medium">
                Vulnerability Scan
              </CardTitle>
            </div>
            {scan.status === 'completed' && (
              <Badge
                variant="outline"
                className={
                  hasVulnerabilities
                    ? hasCritical
                      ? 'bg-red-500/10 text-red-500 border-red-500/20'
                      : hasHigh
                        ? 'bg-orange-500/10 text-orange-500 border-orange-500/20'
                        : 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
                    : 'bg-green-500/10 text-green-500 border-green-500/20'
                }
              >
                {hasVulnerabilities ? `${totalVulnerabilities} found` : 'Clean'}
              </Badge>
            )}
            {scan.status === 'running' && (
              <Badge variant="outline" className="bg-blue-500/10 text-blue-500 border-blue-500/20">
                Running...
              </Badge>
            )}
            {scan.status === 'failed' && (
              <Badge variant="outline" className="bg-red-500/10 text-red-500 border-red-500/20">
                Failed
              </Badge>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          {showEnvironment && environmentName && (
            <div className="text-sm text-muted-foreground">
              Environment: <span className="font-medium">{environmentName}</span>
            </div>
          )}

          {scan.status === 'completed' && hasVulnerabilities && (
            <div className="grid grid-cols-2 gap-2">
              {scan.critical_count > 0 && <SeverityBadge severity="critical" count={scan.critical_count} />}
              {scan.high_count > 0 && <SeverityBadge severity="high" count={scan.high_count} />}
              {scan.medium_count > 0 && <SeverityBadge severity="medium" count={scan.medium_count} />}
              {scan.low_count > 0 && <SeverityBadge severity="low" count={scan.low_count} />}
            </div>
          )}

          {scan.status === 'completed' && !hasVulnerabilities && (
            <div className="flex items-center gap-2 rounded-md bg-green-500/10 text-green-500 border border-green-500/20 px-3 py-2">
              <CheckCircle className="h-4 w-4 flex-shrink-0" />
              <span className="text-sm font-medium">No vulnerabilities found</span>
            </div>
          )}

          {scan.status === 'failed' && scan.error_message && (
            <div className="text-sm text-muted-foreground">
              <span className="text-red-500">Error:</span> {scan.error_message}
            </div>
          )}

          <div className="flex items-center justify-between text-xs text-muted-foreground pt-2 border-t">
            <span>{scan.scanner_type} {scan.scanner_version && `v${scan.scanner_version}`}</span>
            {scan.completed_at ? (
              <TimeAgo date={new Date(scan.completed_at)} />
            ) : (
              <TimeAgo date={new Date(scan.created_at)} />
            )}
          </div>
        </CardContent>
      </Card>
    </Link>
  )
}
