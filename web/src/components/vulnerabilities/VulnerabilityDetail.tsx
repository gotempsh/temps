import { VulnerabilityResponse } from '@/api/client'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { CopyButton } from '@/components/ui/copy-button'
import { Separator } from '@/components/ui/separator'
import { formatDistanceToNow } from 'date-fns'
import { AlertTriangle, CheckCircle, ExternalLink, Info, Package, XCircle } from 'lucide-react'

interface VulnerabilityDetailProps {
  vulnerability: VulnerabilityResponse
}

function getSeverityColor(severity: string): string {
  switch (severity.toUpperCase()) {
    case 'CRITICAL':
      return 'bg-red-500/10 text-red-500 border-red-500/20'
    case 'HIGH':
      return 'bg-orange-500/10 text-orange-500 border-orange-500/20'
    case 'MEDIUM':
      return 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
    case 'LOW':
      return 'bg-blue-500/10 text-blue-500 border-blue-500/20'
    default:
      return 'bg-gray-500/10 text-gray-500 border-gray-500/20'
  }
}

function getSeverityIcon(severity: string) {
  switch (severity.toUpperCase()) {
    case 'CRITICAL':
      return XCircle
    case 'HIGH':
      return AlertTriangle
    case 'MEDIUM':
      return Info
    case 'LOW':
      return CheckCircle
    default:
      return Info
  }
}

export function VulnerabilityDetail({ vulnerability }: VulnerabilityDetailProps) {
  const SeverityIcon = getSeverityIcon(vulnerability.severity)

  // Parse references if they're a JSON string
  let references: string[] = []
  if (vulnerability.references) {
    try {
      if (typeof vulnerability.references === 'string') {
        references = JSON.parse(vulnerability.references)
      } else if (Array.isArray(vulnerability.references)) {
        references = vulnerability.references
      }
    } catch {
      // Ignore parsing errors
    }
  }

  return (
    <div className="space-y-6">
      {/* Header Card */}
      <Card>
        <CardHeader>
          <div className="flex items-start justify-between gap-4">
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <Badge
                  variant="outline"
                  className={`${getSeverityColor(vulnerability.severity)} text-base`}
                >
                  <SeverityIcon className="h-4 w-4 mr-2" />
                  {vulnerability.severity}
                </Badge>
                {vulnerability.cvss_score && (
                  <Badge variant="outline" className="text-base">
                    CVSS {vulnerability.cvss_score.toFixed(1)}
                  </Badge>
                )}
              </div>
              <CardTitle className="text-2xl">{vulnerability.title}</CardTitle>
              <div className="flex items-center gap-2 text-sm text-muted-foreground font-mono">
                <span>{vulnerability.vulnerability_id}</span>
                <CopyButton
                  value={vulnerability.vulnerability_id}
                  className="h-6 w-6 p-0 hover:bg-accent hover:text-accent-foreground rounded-md"
                />
              </div>
            </div>
          </div>
        </CardHeader>
      </Card>

      {/* Package Information */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg flex items-center gap-2">
            <Package className="h-5 w-5" />
            Package Information
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-muted-foreground mb-1">Package</div>
              <div className="font-mono text-sm">{vulnerability.package_name}</div>
            </div>
            <div>
              <div className="text-sm text-muted-foreground mb-1">Installed Version</div>
              <Badge variant="outline" className="font-mono">
                {vulnerability.installed_version}
              </Badge>
            </div>
          </div>
          {vulnerability.fixed_version && (
            <div>
              <div className="text-sm text-muted-foreground mb-1">Fixed in Version</div>
              <Badge
                variant="outline"
                className="font-mono bg-green-500/10 text-green-500 border-green-500/20"
              >
                {vulnerability.fixed_version}
              </Badge>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Description */}
      {vulnerability.description && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Description</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm leading-relaxed whitespace-pre-wrap">
              {vulnerability.description}
            </p>
          </CardContent>
        </Card>
      )}

      {/* Timeline */}
      {(vulnerability.published_date || vulnerability.last_modified_date) && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Timeline</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {vulnerability.published_date && (
              <div>
                <div className="text-sm text-muted-foreground mb-1">Published</div>
                <div className="text-sm">
                  {new Date(vulnerability.published_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}{' '}
                  <span className="text-muted-foreground">
                    ({formatDistanceToNow(new Date(vulnerability.published_date), { addSuffix: true })})
                  </span>
                </div>
              </div>
            )}
            {vulnerability.last_modified_date && (
              <div>
                <div className="text-sm text-muted-foreground mb-1">Last Modified</div>
                <div className="text-sm">
                  {new Date(vulnerability.last_modified_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}{' '}
                  <span className="text-muted-foreground">
                    ({formatDistanceToNow(new Date(vulnerability.last_modified_date), { addSuffix: true })})
                  </span>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* References */}
      {(vulnerability.primary_url || references.length > 0) && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">References</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {vulnerability.primary_url && (
              <div>
                <div className="text-sm text-muted-foreground mb-2">Primary Reference</div>
                <Button variant="outline" size="sm" asChild>
                  <a
                    href={vulnerability.primary_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-2"
                  >
                    View Details
                    <ExternalLink className="h-4 w-4" />
                  </a>
                </Button>
              </div>
            )}

            {references.length > 0 && (
              <>
                {vulnerability.primary_url && <Separator />}
                <div>
                  <div className="text-sm text-muted-foreground mb-2">Additional References</div>
                  <ul className="space-y-2">
                    {references.map((ref, index) => (
                      <li key={index}>
                        <a
                          href={ref}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-sm text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1"
                        >
                          <ExternalLink className="h-3 w-3" />
                          {ref}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  )
}
